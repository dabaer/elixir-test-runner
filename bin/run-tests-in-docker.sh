#!/usr/bin/env bash

# Synopsis:
# Test the Docker image by running it against a predefined set of
# solutions with an expected output.
# The Docker image is built automatically.

# Output:
# Outputs the diff of the expected test results against the actual test results
# generated by the test runner Docker image.

# Example:
# ./bin/run-tests-in-docker.sh

set -e # Make script exit when a command fail.
set -u # Exit on usage of undeclared variable.
# set -x # Trace what gets executed.
set -o pipefail # Catch failures in pipes.

# build docker image
docker build --rm -t elixir-test-runner .

# run image passing the arguments
docker run \
    --rm \
    --network none \
    --read-only \
    --mount type=bind,src=$(realpath test),dst=/opt/test-runner/test \
    --mount type=tmpfs,dst=/tmp \
    --entrypoint /opt/test-runner/bin/smoke_test.sh \
    elixir-test-runner
